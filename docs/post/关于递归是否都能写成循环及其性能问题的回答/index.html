<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://mchhui.github.io/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://mchhui.github.io/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://mchhui.github.io/css/github.min.css' />
    <link rel="stylesheet" href='https://mchhui.github.io/css/github-style.css' />
    <link rel="stylesheet" href='https://mchhui.github.io/css/light.css' />
    <link rel="stylesheet" href='https://mchhui.github.io/css/dark.css' />
    <link rel="stylesheet" href='https://mchhui.github.io/css/syntax.css' />
    <title>关于递归是否都能写成循环及其性能问题的回答 - Hueihuea&#39;s blog | Welcome back, Pilot.</title>
    
    <link rel="icon" type="image/x-icon" href='/images/ico.png'>
    
    <meta name="theme-color" content="#1e2327">

    
    

    
    <meta name="description"
  content="所有递归都可以写成循环,循环通常优于递归" />
<meta name="keywords"
  content='我的世界,minecraft,编程,计算,图形学,渲染,算法,证明' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://mchhui.github.io/post/%E5%85%B3%E4%BA%8E%E9%80%92%E5%BD%92%E6%98%AF%E5%90%A6%E9%83%BD%E8%83%BD%E5%86%99%E6%88%90%E5%BE%AA%E7%8E%AF%E5%8F%8A%E5%85%B6%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98%E7%9A%84%E5%9B%9E%E7%AD%94/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="关于递归是否都能写成循环及其性能问题的回答 - Hueihuea&#39;s blog | Welcome back, Pilot." />
<meta name="twitter:description"
  content="所有递归都可以写成循环,循环通常优于递归" />
<meta name="twitter:site" content="https://mchhui.github.io/" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://mchhui.github.io/">


<meta property="og:type" content="article" />
<meta property="og:title" content="关于递归是否都能写成循环及其性能问题的回答 - Hueihuea&#39;s blog | Welcome back, Pilot.">
<meta property="og:description"
  content="所有递归都可以写成循环,循环通常优于递归" />
<meta property="og:url" content="https://mchhui.github.io/post/%E5%85%B3%E4%BA%8E%E9%80%92%E5%BD%92%E6%98%AF%E5%90%A6%E9%83%BD%E8%83%BD%E5%86%99%E6%88%90%E5%BE%AA%E7%8E%AF%E5%8F%8A%E5%85%B6%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98%E7%9A%84%E5%9B%9E%E7%AD%94/" />
<meta property="og:site_name" content="关于递归是否都能写成循环及其性能问题的回答" />
<meta property="og:image"
  content="https://mchhui.github.io/">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2025-10-20 08:08:28 &#43;0800 CST" />











</head>


<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://mchhui.github.io/">
        <img class="octicon" height="32" width="32" src="/images/github-mark-white.png">
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" version="1.1" width="24">
          <path fill-rule="evenodd" d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
          </path>
        </svg>
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          
          <form target="_blank" action="https://www.baidu.com/s" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="wd" value="" placeholder="Search" autocomplete="off">
              <input type="hidden" name="si" value="site:https://mchhui.github.io/">
            </label>
          </form>
          
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://mchhui.github.io/">
        <img class="octicon octicon-mark-github v-align-middle" height="32" width="32" src="/images/github-mark-white.png">
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>
  <div id="search-result" class="container-lg px-3 new-discussion-timeline" style="display: none;">
</div>

  
<div class="application-main">
  <div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="https://mchhui.github.io/">
                  <img class=" avatar-user"
                    src="/images/avatar.png"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="https://mchhui.github.io/">Hueihuea</a>
                  </span>
                  <span class="path-divider">/</span>
                  <strong class="css-truncate css-truncate-target mr-1" style="max-width: 410px">
                    <a href="https://mchhui.github.io/post/%E5%85%B3%E4%BA%8E%E9%80%92%E5%BD%92%E6%98%AF%E5%90%A6%E9%83%BD%E8%83%BD%E5%86%99%E6%88%90%E5%BE%AA%E7%8E%AF%E5%8F%8A%E5%85%B6%E6%80%A7%E8%83%BD%E9%97%AE%E9%A2%98%E7%9A%84%E5%9B%9E%E7%AD%94/">关于递归是否都能写成循环及其性能问题的回答</a>
                  </strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Mon, 20 Oct 2025 08:08:28 &#43;0800"
                    class="no-wrap">
                    Mon, 20 Oct 2025 08:08:28 &#43;0800</relative-time>

                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div id="post-header" class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style="z-index: 2">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    
                    <summary id="toc-toggle" onclick="clickToc()" class="btn btn-octicon m-0 mr-2 p-2">
                      <svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered">
                        <path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zM3 8a1 1 0 11-2 0 1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"></path>
                      </svg>
                    </summary>
                    <details-menu class="SelectMenu" id="toc-details" style="display: none;">
                      <div class="SelectMenu-modal rounded-3 mt-1" style="max-height: 340px;">
                        <div class="SelectMenu-list SelectMenu-list--borderless p-2" style="overscroll-behavior: contain;" id="toc-list">
                        </div>
                      </div>
                    </details-menu>
                      2867 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                    
                    <a class="muted-link mr-3" href="/tags/%E8%AE%A1%E7%AE%97%E7%90%86%E8%AE%BA">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      计算理论
                    </a>
                    
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5" style="z-index: 1">
                <article class="markdown-body entry-content container-lg"><p>本文是对知乎上“所有递归都可以改写成循环吗？”问题的回答</p>
<blockquote>
<p>话说递归层次比较深的话容易造成stack overflow,还被认为效率不高，而且有人表示所有的递归都可以改写成循环，这是真的吗？</p>
<p>林锐博士的书中曾表示：所有的递归都可以改写成循环，而且认为递归的效率不高。
而王垠博士则认为递归比循环强。
“递归的数据总是需要递归的程序来处理。虽然递归有时候表现为另外的形式，比如循环(loop)，但是“递归”这个概念比“循环”更广泛一些。有很多递归程序不能用循环来表达”
<a href="https://link.zhihu.com/?target=http%3A//blog.sina.com.cn/s/blog_5d90e82f01018ge9.html">http://blog.sina.com.cn/s/blog_5d90e82f01018ge9.html</a></p>
<p>“而其实递归比循环表达能力强很多，而且效率几乎一样。有些程序比如解释器，不用递归的话基本没法完成。”
<a href="https://link.zhihu.com/?target=http%3A//blog.sina.com.cn/s/blog_5d90e82f01015271.html">http://blog.sina.com.cn/s/blog_5d90e82f01015271.html</a></p>
<p>王垠写解释器可是很在行的啊，对循环，递归的理解也应该不错吧。</p>
<p>在此请教各位啦</p>
</blockquote>
<p>我们不管林锐和王垠到底如何，就说标题问题本身（不得不说这是个老生常谈到没必要再谈的话题，但他就神奇在总是让你想谈谈，可能是因为他比较具有迷惑性吧）。</p>
<h3 id="所有递归都可以写成循环">所有递归都可以写成循环</h3>
<p>国内外学界和业界主流观点：所有递归都可以写成循环。</p>
<p>你可以在《编译原理》里找到“一切递归代码都可以写成栈+循环的形式”</p>
<p>但是递归和循环这个词不太严谨，<strong>有歧义。</strong></p>
<p><strong>在一般编程语境下：</strong></p>
<p>递归是指函数自己调用自己</p>
<p>循环是指一段能重复执行零或多次的代码，具体表现成for等控制流语句</p>
<p>显而易见，函数和循环是等价的，互相能写成对方的形式。</p>
<p><strong>在递归论语境下：</strong></p>
<p>递归是有明确定义的，但是循环没有，有的朋友认为循环是尾递归。</p>
<p>那么问题就变成了：递归都能改写成尾递归。</p>
<p>由于尾递归是递归的真子集，“递归都能改写成尾递归”显然是不成立的。</p>
<p>这就是为什么有的朋友认为“并非所有递归都能写成循环”。</p>
<p><strong>如果从可计算性理论的“邱奇-图灵论题”出发：</strong></p>
<p>递归函数和图灵机（无限内存和循环能力）在计算能力上等价。</p>
<p>亦或者从迪杰斯特拉等人的结构化程序设计理论出发：</p>
<p>程序的基本控制流是顺序 选择 循环。</p>
<p>他们证明了拥有这三种控制流的编程语言是图灵完备的（默认无限内存能力）。</p>
<p>需要解释一下 之所以是循环不是goto 是因为他们搞结构化程序设计就是为了反对当时goto的滥用。</p>
<p><strong>还有朋友提到CPS变换</strong>，CPS变换确实可以把递归都改写成尾递归的形式，这样支持尾递归优化的编程语言可以对其进行机械性的优化，但是，就算使用CPS变换，需要的空间复杂度是不会改变的，依旧要存储前面未完成的计算来完成递归中回归的过程，不过是把一般递归形式改成了闭包尾递归罢了。当然这在工程上有一定意义，把栈空间的压力转移到了堆空间上。</p>
<p>但我觉得这俩种语境都不太好，因为一般编程语境不够学术和严谨，但递归论，或者说计算理论，在中国不属于计算机专业的必修课，很多人可能都不知道里面的很多概念，不够普适。而且递归论的语境里循环的概念是不明确的，容易引起不必要的纠纷。</p>
<p>我觉得不如用《Structure and Interpretation of Computer Programs》中的俩个简单的概念来回答这个问题：</p>
<p><strong>递归计算过程：递归计算过程是一种其执行需要解释器维护一个随时间增长和收缩的调用栈的过程。该调用栈用于跟踪在后续计算中必须执行的延迟操作链。这个过程消耗的存储空间与步骤数成正比。</strong></p>
<p><strong>迭代计算过程：迭代计算过程是一种其状态可以由固定数量的状态变量完全描述的计算过程。在过程演进时，存在一套固定的规则，用于在状态转换时更新这些变量，以及一个（可选的）结束测试来指定终止条件。这种过程可以在恒定大小的存储空间内执行，其空间消耗与计算步骤数无关。</strong></p>
<p>那么我们知道，一个不依靠显式栈或者其他无限内存能力的可重复代码（循环）的计算过程，是迭代计算过程，递归和依靠显式栈或者其他无限内存能力的可重复代码（循环）的计算过程，是递归计算过程。显而易见的，一切递归计算过程不能写成迭代计算过程，反之亦然。</p>
<p>注意：递归计算过程要求你的计算过程中，变量必须随时间改变，不可以一直不变。而迭代计算过程要求你的变量必须一直不变，不能多也不能少，不能声明9个变量但某次计算只有8个变量有意义。（注意，这里的变量并非编程语义中的变量，而是状态变量，迭代计算过程的状态变量必须数目一定且全部有意义，保证了依靠巨大状态空间伪装成迭代计算过程的递归计算过程依旧是递归计算过程，举个例子，我申请了一个arr[10000000]来用循环模拟递归，这个计算过程依旧是递归计算过程，因为在计算过程的状态空间中存在无意义的状态变量）</p>
<h3 id="关于性能问题循环通常优于递归">关于性能问题：循环通常优于递归</h3>
<p>由于递归和循环的计算能力的等价的，理论上讲他们的最优实现的复杂度也是一样的。</p>
<p>但是，现实编程里就不一定了。</p>
<p>现实里由于硬件特性，递归需要额外维护额外的栈帧信息，且栈帧的内存连续性不良，同时对寄存器、高速缓存和分支预测不友好，导致递归最优性能通常比循环弱。<strong>这是国内外学界和业界的主流观点</strong>，你在《Algorithms + Data Structures = Programs》等书中都能找到这样的观点。</p>
<p>在有的语言中，调用函数的额外开销比较大，比如Java（栈帧信息更丰富，安全检查更多），这个情况下显式栈+循环对递归的性能优势通常表现的很明显。</p>
<p>插入一个笑话：JVM标准不要求尾递归优化，所以很多JVM遇到尾递归一样会爆栈。</p>
<p>但是，如果是在调用函数额外开销极小的语言中，比如CPP，那么在都使用“软件方法”维护栈（递归维护调用栈，循环维护显式栈），在一定递归深度内，递归和循环的性能应该是相当接近的。
但如果要考虑内存连续性和缓存命中率等问题，那就如我们刚刚说的那样，由于硬件特性，递归天生劣于循环。</p>
<p>可是，有一个问题，在x86等框架下，指令集是包含push等调用栈指令的，这个时候编译器默认生成的“调用硬件维护调用栈的方案”，在递归深度很小的情况下就很有可能比你手写的“软件维护显式栈的方案”快的多。这就是递归比循环快的特例，这种特例其实相当少见，而且，这也是考虑内存连续性和缓存命中率等问题的。</p>
<p>（当然，需要指出的是，手写的循环代码本身也运行在系统调用栈之上，但这部分栈帧开销是两者共有的，并非我们在此比较的重点。）</p>
<p>不过也有几种极端的理想情况：</p>
<p>硬件性能无限，任何算法都立即完成，那这没有任何讨论的必要，硬件牛逼就完了。</p>
<p>编译器的优化能力无限，递归和循环编译出的机器码完全一致。</p>
<p>机器有无限的学习能力，能自动优化内存中的程序，运行一段时间后递归和循环的机器码完全一致，从此在后续计算中性能一致。</p>
<p>不过这几种情况都属于想一想就行，不要想太多，哈哈。</p>
<p>不过说到底，递归和循环之所以在性能上有差距，不就是因为他们天生的底层行为有差异吗？不如直接写汇编，递归函数和循环语句都不存在了，烦恼直接解决了，嘻嘻。</p>
<h3 id="当然最后我还是想说一下我对各类过程的最经典定义的理解">当然，最后我还是想说一下我对各类过程的最经典定义的理解。</h3>
<p>递归：显式函数自己显式地调用自己</p>
<p>循环：可重复执行自身零次或多次的代码段</p>
<p>迭代：由固定数目的旧变量推出等量新变量的收敛过程</p>
<p>递推：由离散序列已知初始值推出后续项的过程</p>
<p>遍历：逐次访问离散序列中的每一项的过程</p>
<p>注：定义中的“显式函数”，特指在编程语言中以函数/方法代码块（包括匿名函数等特殊函数代码块）形式明确定义的可执行实体。此限定旨在将编程中的递归调用，与一段代码在数学上可被理解为函数的情况区分开来。</p>
</article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
<script type="application/javascript" src='https://mchhui.github.io/js/toc.js'></script>
<link rel="stylesheet" href='https://mchhui.github.io/css/toc.css' />

  
<div class="comment-section">
    <h3 class="comment-title">评论区</h3>
    
    
    <div class="comment-form">
        <form id="commentForm">
            <div class="form-group">
                <label for="commentUser">用户名:</label>
                <input type="text" id="commentUser" name="user" placeholder="请输入您的用户名" maxlength="50" required>
            </div>
            
            <div class="form-group">
                <label for="commentMsg">评论内容:</label>
                <textarea id="commentMsg" name="msg" placeholder="请输入您的评论内容" maxlength="1000" required></textarea>
            </div>
            
            <button type="submit">发表评论</button>
        </form>
        
        <div id="commentResult"></div>
    </div>
    
    
    <div class="comments-list">
        <h4 class="comments-title">评论列表</h4>
        <div id="commentList">
            <p class="loading-text">正在加载评论...</p>
        </div>
    </div>
</div>

<script>

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}


function generateTitleHash(title) {
    let hash = 0;
    if (title.length === 0) return hash.toString();
    for (let i = 0; i < title.length; i++) {
        const char = title.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; 
    }
    return Math.abs(hash).toString();
}


const articleTitle = "关于递归是否都能写成循环及其性能问题的回答";
const categoryHash = generateTitleHash(articleTitle);
const apiBaseUrl = "http:\/\/localhost:1066";

console.log('文章标题:', articleTitle);
console.log('分类Hash:', categoryHash);
console.log('API基础URL:', apiBaseUrl);


if (!apiBaseUrl || apiBaseUrl === '') {
    console.error('评论系统API基础URL未配置');
    document.getElementById('commentList').innerHTML = 
        '<div style="color: red;">评论系统配置错误：API基础URL未设置</div>';
}


function validateInput(user, msg) {
    const errors = [];
    
    
    if (!user || user.trim().length === 0) {
        errors.push('用户名不能为空');
    } else if (user.length > 50) {
        errors.push('用户名不能超过50个字符');
    }
    
    
    if (!msg || msg.trim().length === 0) {
        errors.push('评论内容不能为空');
    } else if (msg.length > 1000) {
        errors.push('评论内容不能超过1000个字符');
    }
    
    
    const dangerousPatterns = [
        /\x3Cscript/i,
        /javascript:/i,
        /on\w+\s*=/i,
        /<iframe/i,
        /<object/i,
        /<embed/i
    ];
    
    const allText = user + msg;
    for (const pattern of dangerousPatterns) {
        if (pattern.test(allText)) {
            errors.push('输入内容包含不允许的字符');
            break;
        }
    }
    
    return errors;
}


document.getElementById('commentForm').addEventListener('submit', function(e) {
    e.preventDefault();
    console.log('评论表单提交事件触发');
    
    const user = document.getElementById('commentUser').value.trim();
    const msg = document.getElementById('commentMsg').value.trim();
    
    
    const validationErrors = validateInput(user, msg);
    if (validationErrors.length > 0) {
        document.getElementById('commentResult').innerHTML = 
            '<div class="error">' + validationErrors.join('<br>') + '</div>';
        return;
    }
    
    const formData = new FormData(this);
    formData.append('cate', categoryHash); 
    
    console.log('FormData 创建成功，分类:', categoryHash);
    
    fetch(apiBaseUrl + '/msg', {
        method: 'POST',
        body: formData,
        mode: 'cors',
        credentials: 'omit'
    })
    .then(response => {
        console.log('响应状态:', response.status);
        return response.text();
    })
    .then(data => {
        console.log('响应数据:', data);
        document.getElementById('commentResult').innerHTML = 
            '<div style="color: green; margin-top: 10px;">' + data + '</div>';
        
        this.reset();
        
        loadComments();
    })
    .catch(error => {
        console.error('发送错误:', error);
        let errorMsg = '发送失败: ' + error;
        if (error.name === 'TypeError' && error.message.includes('CORS')) {
            errorMsg = '跨域请求被阻止，请检查后端CORS配置或使用代理';
        }
        document.getElementById('commentResult').innerHTML = 
            '<div style="color: red; margin-top: 10px;">' + errorMsg + '</div>';
    });
});


function loadComments() {
    console.log('loadComments 函数被调用，分类:', categoryHash);
    
    fetch(apiBaseUrl + '/list?cate=' + encodeURIComponent(categoryHash), {
        method: 'GET',
        mode: 'cors',
        credentials: 'omit'
    })
    .then(response => {
        console.log('获取响应状态:', response.status);
        return response.text();
    })
    .then(data => {
        console.log('获取响应数据:', data);
        try {
            const messages = JSON.parse(data);
            console.log('解析成功:', messages);
            displayComments(messages);
        } catch (error) {
            console.error('JSON解析错误:', error);
            document.getElementById('commentList').innerHTML = 
                '<div style="color: red;">加载失败: ' + error + '</div>';
        }
    })
    .catch(error => {
        console.error('获取错误:', error);
        let errorMsg = '加载失败: ' + error;
        if (error.name === 'TypeError' && error.message.includes('CORS')) {
            errorMsg = '跨域请求被阻止，请检查后端CORS配置或使用代理';
        }
        document.getElementById('commentList').innerHTML = 
            '<div style="color: red;">' + errorMsg + '</div>';
    });
}


function displayComments(messages) {
    console.log('displayComments 被调用，数据:', messages);
    const commentList = document.getElementById('commentList');
    
    if (!messages.Msgs || messages.Msgs.length === 0) {
        console.log('没有评论');
        commentList.innerHTML = '<p class="no-comments">暂无评论，快来抢沙发吧！</p>';
        return;
    }
    
    console.log('评论数量:', messages.Msgs.length);
    let html = '';
    
    
    const sortedMessages = messages.Msgs.sort((a, b) => {
        
        return new Date(b.Time) - new Date(a.Time);
    });
    
    sortedMessages.forEach(msg => {
        console.log('处理评论:', msg);
        
        const safeUser = escapeHtml(msg.User || '匿名用户');
        const safeTime = escapeHtml(msg.Time || '');
        const safeMsg = escapeHtml(msg.Msg || '');
        const safeIP = escapeHtml(msg.IP || '');
        
        html += `
            <div class="comment-item">
                <div class="comment-header">
                    <span class="comment-user">${safeUser}</span>
                    <span class="comment-time">${safeTime}</span>
                </div>
                <div class="comment-content">${safeMsg}</div>
                <div class="comment-meta">IP: ${safeIP}</div>
            </div>
        `;
    });
    
    console.log('生成的HTML:', html);
    commentList.innerHTML = html;
}


document.addEventListener('DOMContentLoaded', function() {
    console.log('页面加载完成，开始加载评论');
    loadComments();
});
</script>

<style>
 
.comment-section {
    margin-top: 30px;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
    line-height: 1.5;
}

 
[data-color-mode=dark] .comment-section {
    background-color: #21262d;
    border: 1px solid #30363d;
}

.comment-title {
    color: #24292f;
    margin-bottom: 20px;
    border-bottom: 2px solid #d0d7de;
    padding-bottom: 10px;
    font-size: 18px;
    font-weight: 600;
}

[data-color-mode=dark] .comment-title {
    color: #f0f6fc;
    border-bottom-color: #30363d;
}

 
.comment-form {
    margin-bottom: 30px;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #24292f;
}

[data-color-mode=dark] .form-group label {
    color: #f0f6fc;
}

.form-group input,
.form-group textarea {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #d0d7de;
    border-radius: 6px;
    box-sizing: border-box;
    font-size: 14px;
    background-color: #ffffff;
    color: #24292f;
    transition: border-color 0.2s, box-shadow 0.2s;
}

[data-color-mode=dark] .form-group input,
[data-color-mode=dark] .form-group textarea {
    background-color: #0d1117;
    border-color: #30363d;
    color: #f0f6fc;
}

.form-group input:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #0969da;
    box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.1);
}

[data-color-mode=dark] .form-group input:focus,
[data-color-mode=dark] .form-group textarea:focus {
    border-color: #1f6feb;
    box-shadow: 0 0 0 3px rgba(31, 111, 235, 0.1);
}

.form-group textarea {
    height: 80px;
    resize: vertical;
    font-family: inherit;
}

button[type="submit"] {
    background-color: #24292f;
    color: #ffffff;
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: background-color 0.2s;
}

[data-color-mode=dark] button[type="submit"] {
    background-color: #f0f6fc;
    color: #24292f;
}

button[type="submit"]:hover {
    background-color: #1a1e22;
}

[data-color-mode=dark] button[type="submit"]:hover {
    background-color: #e6edf0;
}

 
.comments-title {
    color: #24292f;
    margin-bottom: 15px;
    font-size: 16px;
    font-weight: 600;
}

[data-color-mode=dark] .comments-title {
    color: #f0f6fc;
}

.loading-text,
.no-comments {
    color: #656d76;
    font-style: italic;
    text-align: center;
    padding: 20px;
}

[data-color-mode=dark] .loading-text,
[data-color-mode=dark] .no-comments {
    color: #8b949e;
}

 
.comment-item {
    background-color: #ffffff;
    border: 1px solid #d0d7de;
    border-radius: 6px;
    padding: 12px 16px;
    margin-bottom: 8px;
    transition: all 0.2s ease;
}

[data-color-mode=dark] .comment-item {
    background-color: #0d1117;
    border-color: #30363d;
}

.comment-item:hover {
    border-color: #0969da;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

[data-color-mode=dark] .comment-item:hover {
    border-color: #1f6feb;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}

.comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.comment-user {
    font-weight: 600;
    color: #24292f;
    font-size: 14px;
}

[data-color-mode=dark] .comment-user {
    color: #f0f6fc;
}

.comment-time {
    font-size: 12px;
    color: #656d76;
}

[data-color-mode=dark] .comment-time {
    color: #8b949e;
}

.comment-content {
    margin: 8px 0;
    line-height: 1.6;
    color: #24292f;
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 14px;
}

[data-color-mode=dark] .comment-content {
    color: #f0f6fc;
}

.comment-meta {
    font-size: 11px;
    color: #656d76;
    border-top: 1px solid #d0d7de;
    padding-top: 8px;
    margin-top: 8px;
}

[data-color-mode=dark] .comment-meta {
    color: #8b949e;
    border-top-color: #30363d;
}

 
#commentResult {
    margin-top: 10px;
}

#commentResult .success {
    color: #1a7f37;
    background-color: #dafbe1;
    border: 1px solid #a2dfa7;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
}

[data-color-mode=dark] #commentResult .success {
    color: #7ee787;
    background-color: #033a16;
    border-color: #238636;
}

#commentResult .error {
    color: #cf222e;
    background-color: #ffebe9;
    border: 1px solid #ffc1cc;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
}

[data-color-mode=dark] #commentResult .error {
    color: #f85149;
    background-color: #67060c;
    border-color: #da3633;
}

 
@media (max-width: 768px) {
    .comment-section {
        margin: 20px 10px;
        padding: 15px;
        max-width: none;
    }
    
    .comment-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }
    
    .comment-time {
        font-size: 11px;
    }
}
</style>


</div>

  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://mchhui.github.io/">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
      <li class="mr-3 mr-lg-0">GitHub and the Invertocat logo are trademarks of <a href="https://github.com/">GitHub, Inc.</a></li>
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>

</body>

<script type="application/javascript" src="https://mchhui.github.io/js/github-style.js"></script>







</html>