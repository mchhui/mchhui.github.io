<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <script type="application/javascript" src='https://mchhui.github.io/js/theme-mode.js'></script>
    <link rel="stylesheet" href='https://mchhui.github.io/css/frameworks.min.css' />
    <link rel="stylesheet" href='https://mchhui.github.io/css/github.min.css' />
    <link rel="stylesheet" href='https://mchhui.github.io/css/github-style.css' />
    <link rel="stylesheet" href='https://mchhui.github.io/css/light.css' />
    <link rel="stylesheet" href='https://mchhui.github.io/css/dark.css' />
    <link rel="stylesheet" href='https://mchhui.github.io/css/syntax.css' />
    <title>计算机图形学故事：固定管线这个名字是怎么来的？ - Hueihuea&#39;s blog | Welcome back, Pilot.</title>
    
    <link rel="icon" type="image/x-icon" href='/images/ico.png'>
    
    <meta name="theme-color" content="#1e2327">

    
    

    
    <meta name="description"
  content="介绍了显卡的发展和固定管线的概念" />
<meta name="keywords"
  content='我的世界,minecraft,编程,计算,图形学,渲染,算法,证明' />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://mchhui.github.io/post/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6%E6%95%85%E4%BA%8B%E5%9B%BA%E5%AE%9A%E7%AE%A1%E7%BA%BF%E8%BF%99%E4%B8%AA%E5%90%8D%E5%AD%97%E6%98%AF%E6%80%8E%E4%B9%88%E6%9D%A5%E7%9A%84/" />


<meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="计算机图形学故事：固定管线这个名字是怎么来的？ - Hueihuea&#39;s blog | Welcome back, Pilot." />
<meta name="twitter:description"
  content="介绍了显卡的发展和固定管线的概念" />
<meta name="twitter:site" content="https://mchhui.github.io/" />
<meta name="twitter:creator" content="" />
<meta name="twitter:image"
  content="https://mchhui.github.io/">


<meta property="og:type" content="article" />
<meta property="og:title" content="计算机图形学故事：固定管线这个名字是怎么来的？ - Hueihuea&#39;s blog | Welcome back, Pilot.">
<meta property="og:description"
  content="介绍了显卡的发展和固定管线的概念" />
<meta property="og:url" content="https://mchhui.github.io/post/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6%E6%95%85%E4%BA%8B%E5%9B%BA%E5%AE%9A%E7%AE%A1%E7%BA%BF%E8%BF%99%E4%B8%AA%E5%90%8D%E5%AD%97%E6%98%AF%E6%80%8E%E4%B9%88%E6%9D%A5%E7%9A%84/" />
<meta property="og:site_name" content="计算机图形学故事：固定管线这个名字是怎么来的？" />
<meta property="og:image"
  content="https://mchhui.github.io/">
<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">

<meta property="article:published_time" content="2025-10-18 13:06:42 &#43;0800 CST" />











</head>


<body>
  <div style="position: relative">
  <header class="Header js-details-container Details px-3 px-md-4 px-lg-5 flex-wrap flex-md-nowrap open Details--on">
    <div class="Header-item mobile-none" style="margin-top: -4px; margin-bottom: -4px;">
      <a class="Header-link" href="https://mchhui.github.io/">
        <img class="octicon" height="32" width="32" src="/images/github-mark-white.png">
      </a>
    </div>
    <div class="Header-item d-md-none">
      <button class="Header-link btn-link js-details-target" type="button"
        onclick="document.querySelector('#header-search').style.display = document.querySelector('#header-search').style.display == 'none'? 'block': 'none'">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 16 16" version="1.1" width="24">
          <path fill-rule="evenodd" d="M1 2.75A.75.75 0 011.75 2h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 2.75zm0 5A.75.75 0 011.75 7h12.5a.75.75 0 110 1.5H1.75A.75.75 0 011 7.75zM1.75 12a.75.75 0 100 1.5h12.5a.75.75 0 100-1.5H1.75z">
          </path>
        </svg>
      </button>
    </div>
    <div style="display: none;" id="header-search"
      class="Header-item Header-item--full flex-column flex-md-row width-full flex-order-2 flex-md-order-none mr-0 mr-md-3 mt-3 mt-md-0 Details-content--hidden-not-important d-md-flex">
      <div
        class="Header-search header-search flex-auto js-site-search position-relative flex-self-stretch flex-md-self-auto mb-3 mb-md-0 mr-0 mr-md-3 scoped-search site-scoped-search js-jump-to">
        <div class="position-relative">
          
          <form target="_blank" action="https://www.baidu.com/s" accept-charset="UTF-8" method="get"
            autocomplete="off">
            <label
              class="Header-search-label form-control input-sm header-search-wrapper p-0 js-chromeless-input-container header-search-wrapper-jump-to position-relative d-flex flex-justify-between flex-items-center">
              <input type="text"
                class="Header-search-input form-control input-sm header-search-input jump-to-field js-jump-to-field js-site-search-focus js-site-search-field is-clearable"
                name="wd" value="" placeholder="Search" autocomplete="off">
              <input type="hidden" name="si" value="site:https://mchhui.github.io/">
            </label>
          </form>
          
        </div>
      </div>
    </div>

    <div class="Header-item Header-item--full flex-justify-center d-md-none position-relative">
      <a class="Header-link " href="https://mchhui.github.io/">
        <img class="octicon octicon-mark-github v-align-middle" height="32" width="32" src="/images/github-mark-white.png">
      </a>
    </div>
    <div class="Header-item" style="margin-right: 0;">
      <a href="javascript:void(0)" class="Header-link no-select" onclick="switchTheme()">
        <svg style="fill: var(--color-profile-color-modes-toggle-moon);" class="no-select" viewBox="0 0 16 16"
          version="1.1" width="16" height="16">
          <path fill-rule="evenodd" clip-rule="evenodd"
            d="M4.52208 7.71754C7.5782 7.71754 10.0557 5.24006 10.0557 2.18394C10.0557 1.93498 10.0392 1.68986 10.0074 1.44961C9.95801 1.07727 10.3495 0.771159 10.6474 0.99992C12.1153 2.12716 13.0615 3.89999 13.0615 5.89383C13.0615 9.29958 10.3006 12.0605 6.89485 12.0605C3.95334 12.0605 1.49286 10.001 0.876728 7.24527C0.794841 6.87902 1.23668 6.65289 1.55321 6.85451C2.41106 7.40095 3.4296 7.71754 4.52208 7.71754Z">
          </path>
        </svg>
      </a>
    </div>
  </header>
</div>
  <div id="search-result" class="container-lg px-3 new-discussion-timeline" style="display: none;">
</div>

  
<div class="application-main">
  <div>
  <main>
    <div class="gisthead pagehead bg-gray-light pb-0 pt-3 mb-4">
      <div class="px-0">
        <div class="mb-3 d-flex px-3 px-md-3 px-lg-5">
          <div class="flex-auto min-width-0 width-fit mr-3">
            <div class="d-flex">
              <div class="d-none d-md-block">
                <a class="avatar mr-2 flex-shrink-0" href="https://mchhui.github.io/">
                  <img class=" avatar-user"
                    src="/images/avatar.png"
                    width="32" height="32"></a>
              </div>
              <div class="d-flex flex-column">
                <h1 class="break-word f3 text-normal mb-md-0 mb-1">
                  <span class="author">
                    <a href="https://mchhui.github.io/">Hueihuea</a>
                  </span>
                  <span class="path-divider">/</span>
                  <strong class="css-truncate css-truncate-target mr-1" style="max-width: 410px">
                    <a href="https://mchhui.github.io/post/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9B%BE%E5%BD%A2%E5%AD%A6%E6%95%85%E4%BA%8B%E5%9B%BA%E5%AE%9A%E7%AE%A1%E7%BA%BF%E8%BF%99%E4%B8%AA%E5%90%8D%E5%AD%97%E6%98%AF%E6%80%8E%E4%B9%88%E6%9D%A5%E7%9A%84/">计算机图形学故事：固定管线这个名字是怎么来的？</a>
                  </strong>
                </h1>
                <div class="note m-0">
                  Created <relative-time datetime="Sat, 18 Oct 2025 13:06:42 &#43;0800"
                    class="no-wrap">
                    Sat, 18 Oct 2025 13:06:42 &#43;0800</relative-time>

                  
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container-lg px-3 new-discussion-timeline">
      <div class="repository-content gist-content">
        <div>
          <div class="js-gist-file-update-container js-task-list-container file-box">
            <div id="file-pytest" class="file my-2">
              <div id="post-header" class="file-header d-flex flex-md-items-center flex-items-start sticky-header" style="z-index: 2">
                <div class="file-info d-flex flex-md-items-center flex-items-start flex-order-1 flex-auto">
                  <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                    
                    <summary id="toc-toggle" onclick="clickToc()" class="btn btn-octicon m-0 mr-2 p-2">
                      <svg aria-hidden="true" viewBox="0 0 16 16" height="16" width="16" class="octicon octicon-list-unordered">
                        <path fill-rule="evenodd" d="M2 4a1 1 0 100-2 1 1 0 000 2zm3.75-1.5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zm0 5a.75.75 0 000 1.5h8.5a.75.75 0 000-1.5h-8.5zM3 8a1 1 0 11-2 0 1 1 0 012 0zm-1 6a1 1 0 100-2 1 1 0 000 2z"></path>
                      </svg>
                    </summary>
                    <details-menu class="SelectMenu" id="toc-details" style="display: none;">
                      <div class="SelectMenu-modal rounded-3 mt-1" style="max-height: 340px;">
                        <div class="SelectMenu-list SelectMenu-list--borderless p-2" style="overscroll-behavior: contain;" id="toc-list">
                        </div>
                      </div>
                    </details-menu>
                      2920 Words
                    

                  </div>
                  <div class="file-actions flex-order-2 pt-0">
                    
                    
                    <a class="muted-link mr-3" href="/tags/%E6%95%85%E4%BA%8B">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      故事
                    </a>
                    
                    <a class="muted-link mr-3" href="/tags/%E5%9B%BE%E5%BD%A2%E5%AD%A6">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      图形学
                    </a>
                    
                    <a class="muted-link mr-3" href="/tags/opengl">
                      <svg class="octicon octicon-tag" viewBox="0 0 16 16" version="1.1" width="16" height="16">
                        <path fill-rule="evenodd"
                          d="M2.5 7.775V2.75a.25.25 0 01.25-.25h5.025a.25.25 0 01.177.073l6.25 6.25a.25.25 0 010 .354l-5.025 5.025a.25.25 0 01-.354 0l-6.25-6.25a.25.25 0 01-.073-.177zm-1.5 0V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 010 2.474l-5.026 5.026a1.75 1.75 0 01-2.474 0l-6.25-6.25A1.75 1.75 0 011 7.775zM6 5a1 1 0 100 2 1 1 0 000-2z">
                        </path>
                      </svg>
                      OpenGL
                    </a>
                    
                    
                  </div>
                </div>
              </div>


              <div class="Box-body px-5 pb-5" style="z-index: 1">
                <article class="markdown-body entry-content container-lg"><h1 id="计算机图形学故事固定管线这个名字是怎么来的">计算机图形学故事：固定管线这个名字是怎么来的？</h1>
<h3 id="前言">前言</h3>
<p>在大部分中文图形学教程中，固定管线都被这样子描述：固定渲染管线，作为早期的渲染方式，通过一系列固定的操作将三维物体投影到二维屏幕上。</p>
<p>也有开发者这样子描述：固定管线其实就是使用的0号着色器。（具体实现可能是这样子，但这只能认为是特例，故这种说法并不严谨）</p>
<p>还有开发者这样子描述：固定管线就是只能调参数不能修改底层代码的渲染架构。</p>
<p>那么，固定管线到底是什么意思呢？</p>
<h3 id="图像计算从纯cpu图形计算到图形加速卡">图像计算：从纯CPU图形计算到图形加速卡</h3>
<p>在渲染技术发展的早期，所有的图像计算都由CPU独立完成，早期显卡主要是把数字图像信号转化为可被显示器接受的模拟信号，而不参与任何计算。然而，CPU图像计算难以满足日益增强的可视化软件发展的要求。在个人电脑领域，1991年，S3 Graphics发布的P86C911改变了这一局面。P86C911能够加速Windows操作系统中的线条绘制、矩形填充以及光栅操作，同时支持高达1MB的显存和16位色深。被认为是世界上第一款2D图形加速卡的P86C911正式开启了2D图形硬件加速时代。随之而来的是1991年到1995年的CPU-图形加速卡在图像计算上的权力交接。1995年，使用图形加速卡来计算2D图形已经成为了主流。而1996年发布的3dfx Voodoo Graphics，则开启了3D图形加速卡的时代。</p>
<p>使用3dfx Voodoo Graphics的渲染流程大概是这样子的：</p>
<ol>
<li>CPU完成顶点变换，图元组装和光照计算（基于Gouraud的局部光照）。</li>
<li>3dfx Voodoo Graphics完成光栅化并写入2D图形加速卡的帧缓冲区，光栅化过程中高效地实现了纹理映射和镜面高光等技术。</li>
<li>3dfx Voodoo Graphics完成透明度测试。</li>
<li>3dfx Voodoo Graphics完成深度计算和深度测试并在后续阶段写入2D图形加速卡的深度缓冲区。</li>
<li>3dfx Voodoo Graphics完成混合等后续阶段（硬件雾化也在该阶段由3dfx Voodoo Graphics完成）。</li>
<li>2D图形加速卡输出给显示器</li>
</ol>
<p>等到了1999年，我们熟悉的GPU才被英伟达发明。世界上第一款GPU GeForce 256集成了顶点变换、图元组装和光照计算等重要渲染流程（注意：这是在个人电脑领域最早的L&amp;T固定功能硬件，但在图形工作站上，1982年就有这种硬件了）。而到了2001年，英伟达发布了世界上第一款支持可编程顶点着色器的GPU显卡GeForce 3. 至此，图形渲染的‘可编程’时代拉开了序幕。那么，在可编程时代到来之前，那种由一系列基于专门的硬件实现的固定流程组成的渲染体系，就被开发者们追溯性地称为——“固定管线”。</p>
<p>事实上，现代GPU内依旧有图像计算专用的固定功能硬件，例如专门的光栅化器等，但是更多的已经消失，比如专门L&amp;T器已经消失，L&amp;T过程融入可编程着色器核心体系了。</p>
<h3 id="固定管线">固定管线</h3>
<p>所谓“管线”，本义指运输流体管道，在计算机科学中被抽象为“数据流处理器”。首先，Fixed-function pipeline 固定管线这个词的诞生时间肯定远远晚于固定管线架构的诞生时间，因为“固定管线”是相对“可编程管线”而言的。所谓固定管线，其实并没有公认的定义，连提出者都尚不清楚，不妨可以这样子定义：历史上基于固定功能硬件设计的渲染管线称为固定管线。</p>
<p>值得注意的是，尽管“管线”一词常常出现在硬件领域，但固定管线的管线是指抽象的“数据流处理器”，而“器”既可能是硬件，也可能是软件，同时，这个管线是多阶段的，就像水管一样，可以很多很多段水管拼接在一起，组成一个更长的水管，渲染管线也是一个由多个小管线组成的大管线。</p>
<p>固定管线（Fixed-function pipeline），直译为固定功能管线，固定功能一词则来源于“固定功能硬件”，而“固定功能硬件”常常是指二十世纪90年代到二十一世纪初显卡上的图形计算硬件。这些硬件主要集成了光栅化等各种图像计算功能，通过强大的并行计算电路，不仅极大地减轻了CPU的工作负担，而且为渲染质量的快速进步奠定了基础。</p>
<p>注意：固定管线更多地是一个技术性术语而非学术性术语，而且是一个出现时间相当晚的术语。事实上，现代GPU内依旧有图像计算专用的固定功能硬件，例如专门的光栅化器等。</p>
<h3 id="opengl的固定管线模式">OpenGL的固定管线模式</h3>
<p>OpenGL规范的第一个发布版本OpenGL1.0于1992年正式发布，在这个时候，世界上第一个2D图形加速卡才刚刚诞生不久，而GPU更是连影子都没有。我们都知道，OpenGL1.0确实包含顶点变换、图元组装和光照计算等功能。但这个时候还没有GPU，因此这些工作一般由CPU+固定功能硬件完成。以Windows中最早（1995年）支持OpenGL1.0的Windows NT 3.51为例，在调用固定管线功能时，会先检测是否有支持该功能的硬件，如果有，使用硬件加速，如果没有，使用纯软件计算。而等到GPU诞生之后，这些功能才被迁移到GPU上。而等到可编程渲染管线出现后，OpenGL中的固定管线一般就被设计成了默认着色器的形式。</p>
<p>我们都知道，OpenGL只是一个规范，具体实现由驱动负责。所以，今天，当你的个人电脑上使用OpenGL固定管线模式编写并运行渲染程序时，图形计算既不运行在CPU上（除非你写软渲染器，⑧抬杆），也不运行在固定功能硬件上，而是运行在GPU上。</p>
<p>我们刚刚讲到，固定管线的管线（整个大管线由多个小管线组成）即可以是软件，也可以是硬件，在这个例子中应该就体现的很好。总之，OpenGL固定管线模式经历了一个从CPU+固定功能硬件到GPU的演变过程，而在今天，如果你用纯CPU计算的方式实现了一个符合OpenGL1.0的图形库，我认为他也可以叫采用了OpenGL固定管线模式。但我不认为这可以叫做固定管线，尽管有人也用固定管线指代固定管线模式。</p>
<blockquote>
<p>Wiki上的描述</p>
<p>In computer graphics, fixed-function is a term primarily used to describe 3D graphics APIs and GPUs designed prior to the advent of programmable shaders. The term is also used to describe APIs and graphics pipelines that do not allow users to change its underlying processing techniques, hence the word &lsquo;fixed&rsquo;. Fixed-function can also refer to graphics processing techniques that employ non-programmable dedicated hardware, like the use of ROPs to rasterize an image.</p>
</blockquote>
<h3 id="补充图形工作站">补充：图形工作站</h3>
<p>图形工作站是一种专门用于图形计算的计算机，可能是专用计算机，也可能是通用计算机。在图形工作站上，固定功能硬件出现得更早，比如在1992年OpenGL1.0的最早的实现就运行在SGI的工作站上。而OpenGL1.0的前身IRIS GL的实现这运行在更早期的图形工作站上。1981年SGI创始人吉姆·克拉克发明的几何发生器，可能是最早的图形计算固定功能硬件，他能进行顶点变换的加速。而SGI于1982年制造的Geometry Engine（具有顶点变换和光照计算功能）等硬件为高性能3D图形计算奠定了基础。</p>
<h3 id="补充geforce-256-和-现代通用gpu">补充：GeForce 256 和 现代通用GPU</h3>
<p>虽然GeForce 256被英伟达定义为第一款GPU，但是GeForce 256并没有通用计算功能，依旧是固定功能硬件。直到2007年发布的GeForce 8800 GTX才允许程序员用c语言变体来绕过图形API直接控制GPU中的计算单元。值得注意的，现代GPU内依然有专门用于图像计算的固定功能硬件，比如专门的光栅化器等，这些固定功能硬件几乎不能通过CUDA等平台调用，理论上讲你可以编写汇编代码走PCI总线去调用这些固定功能硬件，不过在不知道通信协议的情况下，这几乎是不可行的。</p>
</article>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>
<script type="application/javascript" src='https://mchhui.github.io/js/toc.js'></script>
<link rel="stylesheet" href='https://mchhui.github.io/css/toc.css' />

  
<div class="comment-section">
    <h3 class="comment-title">评论区</h3>
    
    
    <div class="comment-form">
        <form id="commentForm">
            <div class="form-group">
                <label for="commentUser">用户名:</label>
                <input type="text" id="commentUser" name="user" placeholder="请输入您的用户名" maxlength="50" required>
            </div>
            
            <div class="form-group">
                <label for="commentMsg">评论内容:</label>
                <textarea id="commentMsg" name="msg" placeholder="请输入您的评论内容" maxlength="1000" required></textarea>
            </div>
            
            <button type="submit">发表评论</button>
        </form>
        
        <div id="commentResult"></div>
    </div>
    
    
    <div class="comments-list">
        <h4 class="comments-title">评论列表</h4>
        <div id="commentList">
            <p class="loading-text">正在加载评论...</p>
        </div>
    </div>
</div>

<script>

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}


function generateTitleHash(title) {
    let hash = 0;
    if (title.length === 0) return hash.toString();
    for (let i = 0; i < title.length; i++) {
        const char = title.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; 
    }
    return Math.abs(hash).toString();
}


const articleTitle = "计算机图形学故事：固定管线这个名字是怎么来的？";
const categoryHash = generateTitleHash(articleTitle);
const apiBaseUrl = "http:\/\/localhost:1066";

console.log('文章标题:', articleTitle);
console.log('分类Hash:', categoryHash);
console.log('API基础URL:', apiBaseUrl);


if (!apiBaseUrl || apiBaseUrl === '') {
    console.error('评论系统API基础URL未配置');
    document.getElementById('commentList').innerHTML = 
        '<div style="color: red;">评论系统配置错误：API基础URL未设置</div>';
}


function validateInput(user, msg) {
    const errors = [];
    
    
    if (!user || user.trim().length === 0) {
        errors.push('用户名不能为空');
    } else if (user.length > 50) {
        errors.push('用户名不能超过50个字符');
    }
    
    
    if (!msg || msg.trim().length === 0) {
        errors.push('评论内容不能为空');
    } else if (msg.length > 1000) {
        errors.push('评论内容不能超过1000个字符');
    }
    
    
    const dangerousPatterns = [
        /\x3Cscript/i,
        /javascript:/i,
        /on\w+\s*=/i,
        /<iframe/i,
        /<object/i,
        /<embed/i
    ];
    
    const allText = user + msg;
    for (const pattern of dangerousPatterns) {
        if (pattern.test(allText)) {
            errors.push('输入内容包含不允许的字符');
            break;
        }
    }
    
    return errors;
}


document.getElementById('commentForm').addEventListener('submit', function(e) {
    e.preventDefault();
    console.log('评论表单提交事件触发');
    
    const user = document.getElementById('commentUser').value.trim();
    const msg = document.getElementById('commentMsg').value.trim();
    
    
    const validationErrors = validateInput(user, msg);
    if (validationErrors.length > 0) {
        document.getElementById('commentResult').innerHTML = 
            '<div class="error">' + validationErrors.join('<br>') + '</div>';
        return;
    }
    
    const formData = new FormData(this);
    formData.append('cate', categoryHash); 
    
    console.log('FormData 创建成功，分类:', categoryHash);
    
    fetch(apiBaseUrl + '/msg', {
        method: 'POST',
        body: formData,
        mode: 'cors',
        credentials: 'omit'
    })
    .then(response => {
        console.log('响应状态:', response.status);
        return response.text();
    })
    .then(data => {
        console.log('响应数据:', data);
        document.getElementById('commentResult').innerHTML = 
            '<div style="color: green; margin-top: 10px;">' + data + '</div>';
        
        this.reset();
        
        loadComments();
    })
    .catch(error => {
        console.error('发送错误:', error);
        let errorMsg = '发送失败: ' + error;
        if (error.name === 'TypeError' && error.message.includes('CORS')) {
            errorMsg = '跨域请求被阻止，请检查后端CORS配置或使用代理';
        }
        document.getElementById('commentResult').innerHTML = 
            '<div style="color: red; margin-top: 10px;">' + errorMsg + '</div>';
    });
});


function loadComments() {
    console.log('loadComments 函数被调用，分类:', categoryHash);
    
    fetch(apiBaseUrl + '/list?cate=' + encodeURIComponent(categoryHash), {
        method: 'GET',
        mode: 'cors',
        credentials: 'omit'
    })
    .then(response => {
        console.log('获取响应状态:', response.status);
        return response.text();
    })
    .then(data => {
        console.log('获取响应数据:', data);
        try {
            const messages = JSON.parse(data);
            console.log('解析成功:', messages);
            displayComments(messages);
        } catch (error) {
            console.error('JSON解析错误:', error);
            document.getElementById('commentList').innerHTML = 
                '<div style="color: red;">加载失败: ' + error + '</div>';
        }
    })
    .catch(error => {
        console.error('获取错误:', error);
        let errorMsg = '加载失败: ' + error;
        if (error.name === 'TypeError' && error.message.includes('CORS')) {
            errorMsg = '跨域请求被阻止，请检查后端CORS配置或使用代理';
        }
        document.getElementById('commentList').innerHTML = 
            '<div style="color: red;">' + errorMsg + '</div>';
    });
}


function displayComments(messages) {
    console.log('displayComments 被调用，数据:', messages);
    const commentList = document.getElementById('commentList');
    
    if (!messages.Msgs || messages.Msgs.length === 0) {
        console.log('没有评论');
        commentList.innerHTML = '<p class="no-comments">暂无评论，快来抢沙发吧！</p>';
        return;
    }
    
    console.log('评论数量:', messages.Msgs.length);
    let html = '';
    
    
    const sortedMessages = messages.Msgs.sort((a, b) => {
        
        return new Date(b.Time) - new Date(a.Time);
    });
    
    sortedMessages.forEach(msg => {
        console.log('处理评论:', msg);
        
        const safeUser = escapeHtml(msg.User || '匿名用户');
        const safeTime = escapeHtml(msg.Time || '');
        const safeMsg = escapeHtml(msg.Msg || '');
        const safeIP = escapeHtml(msg.IP || '');
        
        html += `
            <div class="comment-item">
                <div class="comment-header">
                    <span class="comment-user">${safeUser}</span>
                    <span class="comment-time">${safeTime}</span>
                </div>
                <div class="comment-content">${safeMsg}</div>
                <div class="comment-meta">IP: ${safeIP}</div>
            </div>
        `;
    });
    
    console.log('生成的HTML:', html);
    commentList.innerHTML = html;
}


document.addEventListener('DOMContentLoaded', function() {
    console.log('页面加载完成，开始加载评论');
    loadComments();
});
</script>

<style>
 
.comment-section {
    margin-top: 30px;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
    line-height: 1.5;
}

 
[data-color-mode=dark] .comment-section {
    background-color: #21262d;
    border: 1px solid #30363d;
}

.comment-title {
    color: #24292f;
    margin-bottom: 20px;
    border-bottom: 2px solid #d0d7de;
    padding-bottom: 10px;
    font-size: 18px;
    font-weight: 600;
}

[data-color-mode=dark] .comment-title {
    color: #f0f6fc;
    border-bottom-color: #30363d;
}

 
.comment-form {
    margin-bottom: 30px;
}

.form-group {
    margin-bottom: 15px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #24292f;
}

[data-color-mode=dark] .form-group label {
    color: #f0f6fc;
}

.form-group input,
.form-group textarea {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #d0d7de;
    border-radius: 6px;
    box-sizing: border-box;
    font-size: 14px;
    background-color: #ffffff;
    color: #24292f;
    transition: border-color 0.2s, box-shadow 0.2s;
}

[data-color-mode=dark] .form-group input,
[data-color-mode=dark] .form-group textarea {
    background-color: #0d1117;
    border-color: #30363d;
    color: #f0f6fc;
}

.form-group input:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #0969da;
    box-shadow: 0 0 0 3px rgba(9, 105, 218, 0.1);
}

[data-color-mode=dark] .form-group input:focus,
[data-color-mode=dark] .form-group textarea:focus {
    border-color: #1f6feb;
    box-shadow: 0 0 0 3px rgba(31, 111, 235, 0.1);
}

.form-group textarea {
    height: 80px;
    resize: vertical;
    font-family: inherit;
}

button[type="submit"] {
    background-color: #24292f;
    color: #ffffff;
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: background-color 0.2s;
}

[data-color-mode=dark] button[type="submit"] {
    background-color: #f0f6fc;
    color: #24292f;
}

button[type="submit"]:hover {
    background-color: #1a1e22;
}

[data-color-mode=dark] button[type="submit"]:hover {
    background-color: #e6edf0;
}

 
.comments-title {
    color: #24292f;
    margin-bottom: 15px;
    font-size: 16px;
    font-weight: 600;
}

[data-color-mode=dark] .comments-title {
    color: #f0f6fc;
}

.loading-text,
.no-comments {
    color: #656d76;
    font-style: italic;
    text-align: center;
    padding: 20px;
}

[data-color-mode=dark] .loading-text,
[data-color-mode=dark] .no-comments {
    color: #8b949e;
}

 
.comment-item {
    background-color: #ffffff;
    border: 1px solid #d0d7de;
    border-radius: 6px;
    padding: 12px 16px;
    margin-bottom: 8px;
    transition: all 0.2s ease;
}

[data-color-mode=dark] .comment-item {
    background-color: #0d1117;
    border-color: #30363d;
}

.comment-item:hover {
    border-color: #0969da;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

[data-color-mode=dark] .comment-item:hover {
    border-color: #1f6feb;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}

.comment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.comment-user {
    font-weight: 600;
    color: #24292f;
    font-size: 14px;
}

[data-color-mode=dark] .comment-user {
    color: #f0f6fc;
}

.comment-time {
    font-size: 12px;
    color: #656d76;
}

[data-color-mode=dark] .comment-time {
    color: #8b949e;
}

.comment-content {
    margin: 8px 0;
    line-height: 1.6;
    color: #24292f;
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 14px;
}

[data-color-mode=dark] .comment-content {
    color: #f0f6fc;
}

.comment-meta {
    font-size: 11px;
    color: #656d76;
    border-top: 1px solid #d0d7de;
    padding-top: 8px;
    margin-top: 8px;
}

[data-color-mode=dark] .comment-meta {
    color: #8b949e;
    border-top-color: #30363d;
}

 
#commentResult {
    margin-top: 10px;
}

#commentResult .success {
    color: #1a7f37;
    background-color: #dafbe1;
    border: 1px solid #a2dfa7;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
}

[data-color-mode=dark] #commentResult .success {
    color: #7ee787;
    background-color: #033a16;
    border-color: #238636;
}

#commentResult .error {
    color: #cf222e;
    background-color: #ffebe9;
    border: 1px solid #ffc1cc;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
}

[data-color-mode=dark] #commentResult .error {
    color: #f85149;
    background-color: #67060c;
    border-color: #da3633;
}

 
@media (max-width: 768px) {
    .comment-section {
        margin: 20px 10px;
        padding: 15px;
        max-width: none;
    }
    
    .comment-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
    }
    
    .comment-time {
        font-size: 11px;
    }
}
</style>


</div>

  <div class="footer container-xl width-full p-responsive">
  <div
    class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between flex-sm-items-center pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
    <a aria-label="Homepage" title="GitHub" class="footer-octicon d-none d-lg-block mr-lg-4" href="https://mchhui.github.io/">
      <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24">
        <path fill-rule="evenodd"
          d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z">
        </path>
      </svg>
    </a>
    <ul class="list-style-none d-flex flex-wrap col-12 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
      
      <li class="mr-3 mr-lg-0">Theme by <a href='https://github.com/MeiK2333/github-style'>github-style</a></li>
      
      <li class="mr-3 mr-lg-0">GitHub and the Invertocat logo are trademarks of <a href="https://github.com/">GitHub, Inc.</a></li>
    </ul>
  </div>
  <div class="d-flex flex-justify-center pb-6">
    <span class="f6 text-gray-light"></span>
  </div>


</div>

</body>

<script type="application/javascript" src="https://mchhui.github.io/js/github-style.js"></script>







</html>